name: Linux Desktop Headless via Tailscale (VNC)

on:
  workflow_dispatch:
    inputs:
      ts_authkey:
        description: "Tailscale auth key (recomendo ephemeral)"
        required: true

jobs:
  linux-vnc:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: üîß Setup user
        run: |
          sudo adduser --disabled-password --gecos "" bullet
          echo "bullet:Bullet@12345" | sudo chpasswd
          sudo usermod -aG sudo bullet
          sudo mkdir -p /home/bullet
          sudo chown bullet:bullet /home/bullet
          sudo chmod 755 /home/bullet

      - name: üñ•Ô∏è Install XFCE, Xvfb and x11vnc
        run: |
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            xfce4 xfce4-goodies x11vnc xvfb dbus-x11

      - name: üîó Start headless XFCE in virtual display
        run: |
          export DISPLAY=:1
          Xvfb :1 -screen 0 1920x1080x24 &
          sleep 2
          startxfce4 &
          sleep 5
          echo "startxfce4" | sudo tee /home/bullet/.xsession
          sudo chown bullet:bullet /home/bullet/.xsession

      - name: üîó Start x11vnc (VNC access)
        run: |
          export DISPLAY=:1
          # -shared permite m√∫ltiplos clientes conectarem
          x11vnc -display :1 -nopw -forever -shared -rfbport 5900 &
