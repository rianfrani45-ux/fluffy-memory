name: Linux Desktop via Tailscale (VNC)

on:
  workflow_dispatch:
    inputs:
      ts_authkey:
        description: "Tailscale auth key (ephemeral ou reutiliz√°vel)"
        required: true
      test_mode:
        description: "Run 5-minute test loop"
        type: boolean
        default: false
      runtime_minutes:
        description: "Runtime em minutos (max 360; default 355)"
        required: false
        default: "355"
      loops:
        description: "Quantas vezes reiniciar workflow (0 = infinito)"
        required: false
        default: "0"

concurrency:
  group: tailscale-linux-vnc
  cancel-in-progress: false

jobs:
  linux-vnc:
    runs-on: ubuntu-22.04
    timeout-minutes: 370

    env:
      USERNAME: bullet
      PASSWORD: Bullet@12345
      DISPLAY_NUM: 1
      VNC_PORT: 5900
      NOVNC_PORT: 6080

    steps:
      - name: üîß Setup user
        run: |
          sudo adduser --disabled-password --gecos "" $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $USERNAME
          sudo mkdir -p /home/$USERNAME
          sudo chown $USERNAME:$USERNAME /home/$USERNAME
          sudo chmod 755 /home/$USERNAME

      - name: üñ•Ô∏è Install XFCE, Xvfb, x11vnc, noVNC
        run: |
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            xfce4 xfce4-goodies x11vnc xvfb dbus-x11 novnc websockify \
            firefox

      - name: üîó Start Linux desktop + VNC + noVNC
        run: |
          # Export display virtual
          export DISPLAY=:$DISPLAY_NUM
          
          # Inicia Xvfb
          Xvfb :$DISPLAY_NUM -screen 0 1920x1080x24 &
          sleep 2
          
          # Inicia XFCE nesse display
          sudo -u $USERNAME startxfce4 &
          sleep 5
          
          # Configura .xsession
          echo "startxfce4" | sudo tee /home/$USERNAME/.xsession
          sudo chown $USERNAME:$USERNAME /home/$USERNAME/.xsession

          # Inicia x11vnc para m√∫ltiplos clientes
          x11vnc -display :$DISPLAY_NUM -nopw -forever -shared -rfbport $VNC_PORT &
          
          # Inicia noVNC para acesso via navegador
          websockify --web=/usr/share/novnc $NOVNC_PORT localhost:$VNC_PORT &
          
          # Espera 10s para garantir que tudo subiu
          sleep 10

      - name: üîó Install & connect Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey ${{ inputs.ts_authkey }} --hostname bullet-linux --accept-dns=false
          sleep 5
          IP=$(tailscale ip -4 | head -n1)
          echo "Use este IP para acessar:"
          echo "VNC (app): $IP:5900"
          echo "noVNC (browser): http://$IP:6080"
          echo "Usu√°rio Linux: $USERNAME"
          echo "Senha Linux: $PASSWORD"

      - name: ‚è≥ Keep alive
        run: |
          RUNTIME=${{ inputs.runtime_minutes }}
          if [ "${{ inputs.test_mode }}" = "true" ]; then
            RUNTIME=5
          fi
          END=$(( $(date +%s) + RUNTIME * 60 ))
          while [ $(date +%s) -lt $END ]; do
            LEFT=$(( (END - $(date +%s)) / 60 ))
            echo "Linux VNC alive... ($LEFT min left)"
            sleep 60
          done
