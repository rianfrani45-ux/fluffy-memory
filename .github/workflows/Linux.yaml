name: Linux Desktop via Tailscale

on:
  workflow_dispatch:
    inputs:
      ts_authkey:
        description: "Tailscale auth key"
        required: true

concurrency:
  group: tailscale-linux-gui
  cancel-in-progress: false

jobs:
  linux-gui:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: üîß Setup user (r√°pido e confi√°vel)
        run: |
          # Cria usu√°rio 'bullet' com senha
          sudo adduser --disabled-password --gecos "" bullet
          echo "bullet:Bullet@12345" | sudo chpasswd
          sudo usermod -aG sudo bullet

      - name: üñ•Ô∏è Install XFCE + XRDP
        run: |
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            xfce4 xfce4-goodies xrdp dbus-x11 firefox

          # Corrige sess√£o para XRDP funcionar
          echo "startxfce4" | sudo tee /home/bullet/.xsession
          sudo chown bullet:bullet /home/bullet/.xsession
          sudo chmod 644 /home/bullet/.xsession

          # Configura XRDP para usar Xorg
          sudo sed -i 's/^#\?port=.*/port=3389/' /etc/xrdp/xrdp.ini
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

      - name: üîó Install & connect Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up \
            --authkey ${{ inputs.ts_authkey }} \
            --hostname bullet-linux \
            --accept-dns=false

          echo "Use este IP para conectar via RDP:"
          tailscale ip -4

      - name: ‚è≥ Keep alive
        run: |
          sleep 21500
