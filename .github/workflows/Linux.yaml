name: Linux Desktop Headless via Tailscale

on:
  workflow_dispatch:
    inputs:
      ts_authkey:
        description: "Tailscale auth key (ephemeral recomendado)"
        required: true

concurrency:
  group: tailscale-linux-gui
  cancel-in-progress: false

jobs:
  linux-gui:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: üîß Setup user
        run: |
          sudo adduser --disabled-password --gecos "" bullet
          echo "bullet:Bullet@12345" | sudo chpasswd
          sudo usermod -aG sudo bullet
          sudo mkdir -p /home/bullet
          sudo chown bullet:bullet /home/bullet
          sudo chmod 755 /home/bullet

      - name: üñ•Ô∏è Install XFCE, Xvfb, VNC & browser
        run: |
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            xfce4 xfce4-goodies x11vnc xvfb dbus-x11 novnc websockify \
            firefox

      - name: üîó Start headless XFCE in Xvfb
        run: |
          export DISPLAY=:1
          Xvfb :1 -screen 0 1920x1080x24 &
          sleep 2
          startxfce4 &
          sleep 5
          echo "startxfce4" | sudo tee /home/bullet/.xsession
          sudo chown bullet:bullet /home/bullet/.xsession

      - name: üîó Start x11vnc & noVNC
        run: |
          export DISPLAY=:1
          x11vnc -display :1 -nopw -forever -shared -rfbport 5900 &
          websockify --web=/usr/share/novnc 6080 localhost:5900 &

      - name: üîó Install & connect Tailscale
        shell: bash
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up \
            --authkey ${{ inputs.ts_authkey }} \
            --hostname bullet-linux \
            --accept-dns=false

          # Espera Tailscale inicializar IP
          sleep 5
          IP=$(tailscale ip -4 | head -n1)

          echo "Use este IP para acessar:"
          echo "VNC: $IP:5900"
          echo "noVNC (browser): http://$IP:6080"
          echo "Usu√°rio Linux: bullet"
          echo "Senha Linux: Bullet@12345"

          # ‚úÖ GitHub Actions summary compat√≠vel 100%
          printf "### Linux Headless via Tailscale\nVNC: %s:5900\nnoVNC: http://%s:6080\nUsu√°rio: bullet\nSenha: Bullet@12345\n" "$IP" "$IP" >> $GITHUB_STEP_SUMMARY

      - name: ‚è≥ Keep alive
        run: |
          sleep 21500
